<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raffleq</title>
    <link rel="icon" href="assets/icons/icon.svg">
    <link rel="manifest" href="raffler.webmanifest" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        .col {
            max-width: 750px;
        }

        .col>.input-group {
            max-width: 500px;
        }

        #winner {
            font-size: 3em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .flex-0-0-auto {
            flex: 0 0 auto;
        }

        .flex-1-1-100 {
            flex: 1 1 100%;
        }
    </style>
</head>

<body class="d-flex flex-column vh-100 vw-100 overflow-hidden">
    <nav class="flex-0-0-auto navbar navbar-expand-lg bg-primary">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <div class="navbar-brand text-light me-1">Raffleq</div>
                <button type="button" class="m-0 p-2 fs-4 btn btn-primary" onclick="openGitHubLink()">
                    <i class="bi bi-github"></i>
                </button>
                <!-- Button trigger modal -->
                <button type="button" class="m-0 p-2 fs-4 btn btn-primary" data-bs-toggle="modal"
                    data-bs-target="#buyMeACoffeeModal">
                    <i class="bi bi-cup-hot-fill"></i>
                </button>

                <!-- Modal -->
                <div class="modal fade" id="buyMeACoffeeModal" tabindex="-1" aria-labelledby="buyMeACoffeeModal"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Buy me a coffee!</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Thank you for using Raffler!
                                If you find this tool useful, please consider buying me a coffee.
                                I would greatly appreciate it!
                                <div class="d-flex justify-content-center mt-3">
                                    <script type="text/javascript"
                                        src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
                                        data-name="bmc-button" data-slug="pjweaver" data-color="#FFDD00" data-emoji=""
                                        data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000"
                                        data-font-color="#000000" data-coffee-color="#ffffff"></script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-outline-light me-2" type="button" onclick="resetEntries()">
                    Reset Entries
                </button>
                <button class="btn btn-danger" type="button" onclick="resetPrompt()">
                    Reset
                </button>
            </div>
        </div>
    </nav>
    <div class="flex-1-1-100 h-100 container-fluid m-0 mt-4 d-flex flex-column overflow-hidden">
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col text-center">
                <button class="btn btn-outline-primary me-2" type="button" onclick="importData()">Import</button>
                <button class="btn btn-outline-primary me-2" type="button" onclick="exportData()">Export</button>
            </div>
        </div>
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col">
                <div class="input-group mx-auto">
                    <input id="name-input" type="text" class="form-control" placeholder="Name" aria-label="Name"
                        aria-describedby="add-button">
                    <button class="btn btn-outline-secondary" type="button" id="add-button"
                        onclick="addParticipant()">Add</button>
                </div>
            </div>
        </div>
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col">
                <!-- <button class="btn btn-primary" type="button" onclick="pickAnInstantWinner()">Pick a winner</button> -->
                <button class="btn btn-primary" type="button" onclick="pickAScrollingWinner()">Pick a winner</button>
            </div>
        </div>
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center d-none">
            <div class="col" id="winner"></div>
        </div>
        <div class="flex-1-1-100 row justify-content-center overflow-scroll">
            <div class="col">
                <ul class="list-group">
                    <!-- List items will be dynamically added here -->
                </ul>
            </div>
        </div>
    </div>

    <template id="list-item-template">
        <li class="list-group-item">
            <div class="container-fluid p-0">
                <div class="row justify-content-between align-items-center">
                    <div class="col-12 col-sm-4">
                        <div id="name" class="me-5 fw-bold">
                            <!-- Name will be dynamically added here -->
                        </div>
                    </div>
                    <div class="col-12 col-sm-8">
                        <div class="d-flex ms-auto" style="max-width: 25em;">
                            <div class="input-group me-2">
                                <button id="subtract" class="btn btn-danger" onclick="subtractEntry(event)">-</button>
                                <input type="number" class="form-control" value="0" onchange="changeEntry(event)">
                                <button id="add" class="btn btn-success" onclick="addEntry(event)">+</button>
                            </div>
                            <button id="delete" class="btn btn-danger" onclick="deleteListItem(event)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </li>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script>
        const openGitHubLink = () => {
            window.open('https://github.com/jbw716/Raffler', '_blank', 'noopener,noreferrer');
            if (newWindow) newWindow.opener = null;
        };

        const participants = [];

        const list = document.querySelector('.list-group');
        const nameInput = document.querySelector('#name-input');
        nameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                addParticipant();
            }
        });

        const deleteListItem = (event) => {
            const button = event.target;
            const li = button.parentElement.parentElement.parentElement.parentElement.parentElement;
            const name = li.querySelector('#name').innerText;
            if (confirm(`Are you sure you want to remove ${name}?`)) {
                const index = participants.findIndex((item) => item.name === name);
                participants.splice(index, 1);
                li.remove();
                saveParticipants();
                console.log(participants);
            }
        }

        const subtractEntry = (event) => {
            const button = event.target;
            const row = button.parentElement.parentElement.parentElement.parentElement;
            const name = row.querySelector('#name').innerText;
            const index = participants.findIndex((item) => item.name === name);
            if (participants[index].entries > 0) {
                participants[index].entries--;
                row.querySelector('input').value = participants[index].entries;
                saveParticipants();
                console.log(participants);
            }
        }

        const addEntry = (event) => {
            const button = event.target;
            const row = button.parentElement.parentElement.parentElement.parentElement;
            const name = row.querySelector('#name').innerText;
            const index = participants.findIndex((item) => item.name === name);
            participants[index].entries++;
            row.querySelector('input').value = participants[index].entries;
            saveParticipants();
            console.log(participants);
        }

        const changeEntry = (event) => {
            const input = event.target;
            const row = input.parentElement.parentElement.parentElement.parentElement;
            const name = row.querySelector('#name').innerText;
            const index = participants.findIndex((item) => item.name === name);
            participants[index].entries = parseInt(input.value);
            saveParticipants();
            console.log(participants);
        }

        const addParticipant = (name = null, entries = 1) => {
            if (name === null) {
                name = nameInput.value;
            }
            name = name.trim();
            if (name === '') {
                alert('Please enter a name.');
                return;
            }
            if (participants.some((participant) => participant.name === name)) {
                alert(`${name} is already added.`);
                nameInput.value = '';
                return;
            }
            const participant = {
                name,
                entries
            };
            participants.push(participant);
            nameInput.value = '';

            participants.sort((a, b) => {
                if (a.name < b.name) {
                    return -1;
                }
                else if (a.name > b.name) {
                    return 1;
                }
                else {
                    return 0;
                }
            });

            renderList();
            saveParticipants();
            console.log(participants);
        };

        const renderList = () => {
            list.innerHTML = '';
            for (const participant of participants) {
                renderListItem(participant);
            }
        };

        const renderListItem = (participant) => {
            const listItem = document.querySelector('#list-item-template').content.cloneNode(true);
            const name = listItem.querySelector('#name');
            name.innerText = participant.name;
            const entriesInput = listItem.querySelector('input');
            entriesInput.value = participant.entries;
            list.appendChild(listItem);
        };

        const resetPrompt = () => {
            if (confirm('Are you sure you want to reset?')) {
                resetRaffle();
            }
        };

        const resetRaffle = () => {
            list.innerHTML = '';
            participants.length = 0;
            saveParticipants();
        }

        const resetEntries = () => {
            if (confirm('Are you sure you want to reset entries?')) {
                for (const participant of participants) {
                    participant.entries = 0;
                }
                const entriesInputs = document.querySelectorAll('input[type=number]');
                for (const entriesInput of entriesInputs) {
                    entriesInput.value = 0;
                }
                saveParticipants();
            }
        };

        // const pickAnInstantWinner = () => {
        //     const totalEntries = participants.reduce((total, participant) => {
        //         return total + participant.entries;
        //     }, 0);
        //     const winningNumber = Math.floor(Math.random() * totalEntries);
        //     let currentTotal = 0;
        //     for (const participant of participants) {
        //         currentTotal += participant.entries;
        //         if (currentTotal > winningNumber) {
        //             alert(`${participant.name} is the winner!`);
        //             break;
        //         }
        //     }
        // }

        const disableAllButtonsAndInputs = () => {
            const buttons = document.querySelectorAll('button');
            for (const button of buttons) {
                button.disabled = true;
            }
            const inputs = document.querySelectorAll('input');
            for (const input of inputs) {
                input.disabled = true;
            }
        }

        const enableAllButtonsAndInputs = () => {
            const buttons = document.querySelectorAll('button');
            for (const button of buttons) {
                button.disabled = false;
            }
            const inputs = document.querySelectorAll('input');
            for (const input of inputs) {
                input.disabled = false;
            }
        }

        const pickAScrollingWinner = (i = 0) => {
            disableAllButtonsAndInputs();
            if (participants.length === 0) {
                alert('Please add some participants to pick a winner.');
                enableAllButtonsAndInputs();
                return;
            }
            if (participants.every((participant) => participant.entries === 0)) {
                alert('All entries are 0.');
                enableAllButtonsAndInputs();
                return;
            }
            const winner = document.querySelector('#winner');
            winner.parentElement.classList.remove('d-none');
            console.log(winner.class)
            winner.style.color = 'black';
            new Promise(resolve => {
                const totalEntries = participants.reduce((total, participant) => {
                    return total + participant.entries;
                }, 0);
                const winningNumber = Math.floor(Math.random() * totalEntries);
                let currentTotal = 0;
                for (const participant of participants) {
                    currentTotal += participant.entries;
                    if (currentTotal > winningNumber) {
                        winner.innerText = participant.name;
                        if (i === 49) {
                            winner.style.color = 'green';
                            setTimeout(() => alert(`${participant.name} is the winner!`));
                            resolve();
                        }
                        break;
                    }
                }
                // Exponential algorithm so that delay at 0 is 0ms and delay at 49 is 500ms.
                const delay = Math.pow(1.1352, i);
                setTimeout(resolve, delay);
            }).then(() => {
                if (i < 49) {
                    pickAScrollingWinner(i + 1);
                }
                else {
                    enableAllButtonsAndInputs();
                }
            });
        }

        const exportData = () => {
            const data = JSON.stringify(participants);
            const blob = new Blob([data], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'raffler-data.json';
            a.click();
        };

        const importData = () => {
            if (participants.length > 0) {
                if (!confirm('Are you sure you want to import data? This will overwrite your current data.')) {
                    return;
                }
            }
            resetRaffle();
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.addEventListener('load', (event) => {
                    const data = JSON.parse(event.target.result);
                    for (const participant of data) {
                        addParticipant(participant.name, participant.entries);
                    }
                });
                reader.readAsText(file);
            });
            input.click();
        }

        const saveParticipants = () => {
            localStorage.setItem('participants', JSON.stringify(participants));
        };

        const loadParticipants = () => {
            const participantsJSON = localStorage.getItem('participants');
            if (participantsJSON !== null) {
                const participantsArray = JSON.parse(participantsJSON);
                for (const participant of participantsArray) {
                    addParticipant(participant.name, participant.entries);
                }
            }
        };

        loadParticipants();
    </script>
</body>

</html>