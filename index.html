<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Raffler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        .col {
            max-width: 750px;
        }

        .col>.input-group {
            max-width: 500px;
        }

        #winner {
            font-size: 3em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .flex-0-0-auto {
            flex: 0 0 auto;
        }

        .flex-1-1-100 {
            flex: 1 1 100%;
        }
    </style>
</head>

<body class="d-flex flex-column vh-100 vw-100 overflow-hidden">
    <nav class="flex-0-0-auto navbar navbar-expand-lg bg-primary">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <div class="navbar-brand text-light">Raffler</div>
                <a href="https://github.com/jbw716/Raffler" target="_blank" rel="noopener"
                    class="m-0 signal_cellular_connected_no_internet_4_bar fs-4 text-light bi bi-github"></a>
                <a class="ms-4" href="https://www.buymeacoffee.com/pjweaver" target="_blank">
                    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee"
                        style="height: 40px !important;"></a>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-outline-light me-2" type="button" onclick="resetEntries()">Reset
                    Entries</button>
                <button class="btn btn-danger" type="button" onclick="resetRaffle()">Reset</button>
            </div>
        </div>
    </nav>
    <div class="flex-1-1-100 h-100 container-fluid m-0 mt-4 d-flex flex-column overflow-hidden">
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col text-center">
                <button class="btn btn-outline-primary me-2" type="button" onclick="importData()">Import</button>
                <button class="btn btn-outline-primary me-2" type="button" onclick="exportData()">Export</button>
            </div>
        </div>
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col">
                <div class="input-group mx-auto">
                    <input id="name-input" type="text" class="form-control" placeholder="Name" aria-label="Name"
                        aria-describedby="add-button">
                    <button class="btn btn-outline-secondary" type="button" id="add-button"
                        onclick="addParticipant()">Add</button>
                </div>
            </div>
        </div>
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col">
                <!-- <button class="btn btn-primary" type="button" onclick="pickAnInstantWinner()">Pick a winner</button> -->
                <button class="btn btn-primary" type="button" onclick="pickAScrollingWinner()">Pick a winner</button>
            </div>
        </div>
        <div class="flex-0-0-auto row mb-3 justify-content-center text-center">
            <div class="col" id="winner">

            </div>
        </div>
        <div class="flex-1-1-100 row justify-content-center overflow-scroll">
            <div class="col">
                <ul class="list-group">
                    <!-- List items will be dynamically added here -->
                </ul>
            </div>
        </div>
    </div>

    <template id="list-item-template">
        <li class="list-group-item">
            <div class="container-fluid p-0">
                <div class="row justify-content-between align-items-center">
                    <div class="col-12 col-sm-4">
                        <div id="name" class="me-5 fw-bold">
                            <!-- Name will be dynamically added here -->
                        </div>
                    </div>
                    <div class="col-12 col-sm-8">
                        <div class="d-flex ms-auto" style="max-width: 25em;">
                            <div class="input-group me-2">
                                <button id="subtract" class="btn btn-danger" onclick="subtractEntry(event)">-</button>
                                <input type="number" class="form-control" value="0" onchange="changeEntry(event)">
                                <button id="add" class="btn btn-success" onclick="addEntry(event)">+</button>
                            </div>
                            <button id="delete" class="btn btn-danger" onclick="deleteParent(event)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </li>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script>
        const participants = [];

        const list = document.querySelector('.list-group');
        const nameInput = document.querySelector('#name-input');
        nameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                addParticipant();
            }
        });

        const deleteParent = (event) => {
            const button = event.target;
            const parent = button.parentElement;
            const grandParent = parent.parentElement;
            const name = grandParent.querySelector('#name').innerText;
            if (confirm(`Are you sure you want to remove ${name}?`)) {
                const index = participants.findIndex((item) => item.name === name);
                participants.splice(index, 1);
                grandParent.remove();
                saveParticipants();
                console.log(participants);
            }
        }

        const subtractEntry = (event) => {
            const button = event.target;
            const parent = button.parentElement;
            const grandParent = parent.parentElement;
            const greatGrandParent = grandParent.parentElement;
            const name = greatGrandParent.querySelector('#name').innerText;
            const index = participants.findIndex((item) => item.name === name);
            if (participants[index].entries > 0) {
                participants[index].entries--;
                parent.querySelector('input').value = participants[index].entries;
                saveParticipants();
                console.log(participants);
            }
        }

        const addEntry = (event) => {
            const button = event.target;
            const parent = button.parentElement;
            const grandParent = parent.parentElement;
            const greatGrandParent = grandParent.parentElement;
            const name = greatGrandParent.querySelector('#name').innerText;
            const index = participants.findIndex((item) => item.name === name);
            participants[index].entries++;
            parent.querySelector('input').value = participants[index].entries;
            saveParticipants();
            console.log(participants);
        }

        const changeEntry = (event) => {
            const input = event.target;
            const parent = input.parentElement;
            const grandParent = parent.parentElement;
            const greatGrandParent = grandParent.parentElement;
            const name = greatGrandParent.querySelector('#name').innerText;
            const index = participants.findIndex((item) => item.name === name);
            participants[index].entries = parseInt(input.value);
            saveParticipants();
            console.log(participants);
        }

        const addParticipant = (name = null, entries = 0) => {
            if (name === null) {
                name = nameInput.value;
            }
            if (name === '') {
                alert('Please enter a name.');
                return;
            }
            if (participants.some((participant) => participant.name === name)) {
                alert(`${name} is already added.`);
                nameInput.value = '';
                return;
            }
            const participant = {
                name,
                entries
            };
            participants.push(participant);
            nameInput.value = '';

            const template = document.querySelector('#list-item-template');
            const listItem = template.content.cloneNode(true);
            const listGroupItem = listItem.querySelector('.list-group-item');
            listGroupItem.querySelector('#name').innerText = name;
            listGroupItem.querySelector('input').value = entries;

            list.appendChild(listItem);
            saveParticipants();
            console.log(participants);
        };

        const resetRaffle = () => {
            if (confirm('Are you sure you want to reset?')) {
                list.innerHTML = '';
                participants.length = 0;
                saveParticipants();
            }
        };

        const resetEntries = () => {
            if (confirm('Are you sure you want to reset entries?')) {
                for (const participant of participants) {
                    participant.entries = 0;
                }
                const entriesInputs = document.querySelectorAll('input[type=number]');
                for (const entriesInput of entriesInputs) {
                    entriesInput.value = 0;
                }
                saveParticipants();
            }
        };

        const pickAnInstantWinner = () => {
            const totalEntries = participants.reduce((total, participant) => {
                return total + participant.entries;
            }, 0);
            const winningNumber = Math.floor(Math.random() * totalEntries);
            let currentTotal = 0;
            for (const participant of participants) {
                currentTotal += participant.entries;
                if (currentTotal > winningNumber) {
                    alert(`${participant.name} is the winner!`);
                    break;
                }
            }
        }

        const pickAScrollingWinner = (i = 0) => {
            const winner = document.querySelector('#winner');
            winner.style.color = 'black';
            new Promise(resolve => {
                const totalEntries = participants.reduce((total, participant) => {
                    return total + participant.entries;
                }, 0);
                const winningNumber = Math.floor(Math.random() * totalEntries);
                let currentTotal = 0;
                for (const participant of participants) {
                    currentTotal += participant.entries;
                    if (currentTotal > winningNumber) {
                        winner.innerText = participant.name;
                        if (i === 49) {
                            winner.style.color = 'green';
                            setTimeout(() => alert(`${participant.name} is the winner!`));
                            resolve();
                        }
                        break;
                    }
                }
                // Exponential algorithm so that delay at 0 is 0ms and delay at 49 is 500ms.
                const delay = Math.pow(1.1352, i);
                setTimeout(resolve, delay);
            }).then(() => {
                if (i < 49) {
                    pickAScrollingWinner(i + 1);
                }
            });
        }

        const saveParticipants = () => {
            localStorage.setItem('participants', JSON.stringify(participants));
        };

        const loadParticipants = () => {
            const participantsJSON = localStorage.getItem('participants');
            if (participantsJSON !== null) {
                const participantsArray = JSON.parse(participantsJSON);
                for (const participant of participantsArray) {
                    addParticipant(participant.name, participant.entries);
                }
            }
        };

        loadParticipants();

        const exportData = () => {
            const data = JSON.stringify(participants);
            const blob = new Blob([data], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'raffler-data.json';
            a.click();
        };

        const importData = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.addEventListener('load', (event) => {
                    const data = JSON.parse(event.target.result);
                    for (const participant of data) {
                        addParticipant(participant.name, participant.entries);
                    }
                });
                reader.readAsText(file);
            });
            input.click();
        }
    </script>
</body>

</html>